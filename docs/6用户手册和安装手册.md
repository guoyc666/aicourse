# 用户手册

## 1. 引言

## 1.1 文档目的

本用户手册旨在指导教师、学生和管理员使用 **AI 辅助的个性化学习系统**，说明系统功能、使用流程、常见问题及解决方案。

## 1.2 目标用户

- 任课教师（资源上传、题库管理、学习评估）
- 学生（学习资源浏览、AI 问答、练习、查看学习路径）
- 系统管理员（用户管理、系统监控）

## 1.3 文档结构

本手册包含从系统安装到使用、异常处理与常见问题的全流程指导。

## 2. 基本操作（面向用户）

### 教师（资源维护与题库）

- 登录后进入“资源管理”：点击上传，选择文件（支持 PDF/PPT/图片/视频），填写标题、章节与关键词，提交后系统会解析并抽取元数据。
- 在“题库管理”模块新增/编辑题目，并在题目中关联知识点（或选择自动关联功能）。
- 查看学生学习图谱与掌握度，导出成绩/练习记录用于教学分析。
- 可创建任务并委派给学生，跟踪完成情况。
- 参与讨论区互动。

### 学生（学习与答题）

- 在课程首页查看知识图谱，按知识点浏览资源与推荐学习路径。
- 使用“AI 问答”输入问题，系统返回基于检索增强（RAG）的答案与来源文档。
- 在练习模块做题，提交后系统会记录答题情况并更新掌握度指标。
- 查看个性化学习路径建议与进度可视化。
- 完成任务并提交给教师审核。
- 讨论区互动。

### 管理员

- 管理用户与角色（教师/学生/管理员），分配权限。
- 监控系统运行状态，执行数据备份与恢复操作。

## 3. 常见问题与排查（用户侧）

Q1：上传文件后没有被解析？

- 检查文件格式是否受支持（PDF/PPT/文本/图片/视频）。
- 后端解析任务可能异步，稍等片刻并刷新页面；如长时间未解析，查看后端日志并联系管理员。

Q2：AI 问答结果不准确？

- 检查是否使用了足够的检索上下文（top_k 参数）；RAG 的质量受向量化与检索结果影响。
- 若为模型微调问题，需要开发组调整微调数据或增强检索库。

Q3：忘记密码或登录失败？

- 使用管理员提供的用户管理界面重置密码，或联系管理员检查认证服务日志。

Q4：某个资源无法下载或打开？

- 检查该资源在 uploads/ 或 data/ 目录是否存在；若缺失请联系管理员恢复备份。

---

# 安装手册

本安装手册按“演示/一键部署（Docker Compose）”与“开发模式手动部署”两个场景给出完整步骤，示例命令以 Windows bash 为主。

## 环境准备（先决条件）

- 操作系统：Windows 10+ / Ubuntu 18.04+
- 已安装：Docker、Docker Compose
- 开发调试时：Python 3.10+、Node.js 16+
- 可选：支持 CUDA 的 GPU（用于模型微调）

在 bash 中验证：

```bash
docker --version
docker compose version
python --version
node --version
```

## 第三方 api

### 图片识别

请前往 [讯飞开放平台](https://www.xfyun.cn/) 注册账号，并创建应用以获取对应的 **API Key** 和 **服务地址**。

### 嵌入（Embedding）与重排序（Rerank）

嵌入与重排序功能可通过以下任一方式实现：

#### 使用讯飞星辰 MaaS 服务

请访问 [讯飞星辰模型广场](https://maas.xfyun.cn/modelSquare)，注册并创建应用，获取所需的 **API Key** 和 **服务地址**。

您也可以选择接入其他支持嵌入和重排序能力的 AI 平台 API。

#### 本地部署

使用huggingface的`shibing624/text2vec-base-chinese`和`cross-encoder/mmarco-mMiniLMv2-L12-H384-v1`模型

1. 安装依赖库：

   ```bash
   pip install sentence-transformers
   ```

2. 修改代码：  
   打开 `backend/utils/ai_client.py` 文件，将其中的 `get_embedding` 和 `get_rerank` 函数替换为本地实现版本 `_get_embedding` 和 `_get_rerank`。

> **提示**：首次运行需下载模型，请确保可以访问 [huggingface](https:\\huggingface.co)平台


## 垂直大模型

详细见[微调指南](../tunning/readme.md)

1. 进入微调文件夹

```bash
cd tunning
```

2. 安装依赖

```bash
pip install transformers sentence-transformers peft datasets
```

3. 生成问答对

```bash
cd tunning
python qa.py --raw-dir <path_to_raw_data> --out-dir <path_to_output_data>
```

4. 微调模型

```bash
python tuning.py
    --base_model Qwen/Qwen3-7B
    --dataset dataset.jsonl
    --output_dir ./ckpts
    --output_log ./logs
    --output_lora ./lora_adapter
    --output_base ./base_model
    --epochs 3
    --batch_size 8
    --accum_steps 2
    --lr 2e-5
    --max_length 512
    --save_base_model

# 启动 TensorBoard 查看日志
tensorboard --logdir ./logs/
```

5. 部署

```bash
python -m vllm.entrypoints.api_server \
  --model ./base_model \
  --model-name my_model \
  --lora-modules ./lora_adapter \
  --port 8888
```

修改环境变量
OPENAI_API_KEY=dummy
OPENAI_BASE_URL=http://localhost:8888/v1
OPENAI_MODEL=my_model

或者上传到讯飞、硅基流动等云服务平台进行部署，相应修改`OPENAI_*`。

## 一、演示/一键部署（推荐：Docker Compose）

1. 在项目根目录（包含 `docker-compose.yml`）打开 bash。
2. 拉取镜像并构建（如需忽略拉取失败）：

```bash
docker compose pull --ignore-pull-failures
docker compose up -d --build
```

3. 验证服务是否启动：

```bash
docker compose ps
```

4. 访问服务：

- 前端：http://localhost:3000
- 后端 API：http://localhost:8000
- Neo4j 浏览器：http://localhost:7474（Bolt 7687）
- MySQL：3306

5. 查看日志（实时）：

```bash
docker compose logs -f backend
docker compose logs -f ai_mysql
docker compose logs -f ai_neo4j
```

6. 停止与清理：

```bash
# 停止但保留数据卷
docker compose down
# 停止并移除数据卷（慎用，会删除数据库与图谱数据）
docker compose down -v
```

### 注意事项

- 修改 `docker-compose.yml` 中的 `MYSQL_ROOT_PASSWORD` 或 `NEO4J_AUTH` 后，若已初始化数据库，直接改密码可能无效；建议在首次部署前设置正确密码，或重建卷并导入初始数据。
- 若需要启用 GPU 训练容器，确保 Docker 与宿主机已配置 NVIDIA Container Toolkit（仅在需要微调时）。

## 二、开发模式手动部署（适合开发与调试）

以下步骤在不使用容器或混合容器/本地模式下研发时使用。

### 后端（本地运行）

1. 创建并激活 Python 虚拟环境：

```bash
cd backend
python -m venv .venv
.\.venv\Scripts\Activate.ps1
```

2. 安装依赖：

```bash
pip install -r backend/requirements.txt
```

3. 配置环境变量（仿照`.env.example`创建 `.env`，并修改相关配置）。

4. 运行后端服务（开发模式，启用热重载）：

```bash
python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

5. 推荐：在首次运行后，执行初始化脚本（`init_data.py`），以导入演示数据：

```bash
python init_data.py
```

### 前端（本地运行）

```bash
cd frontend
npm install
npm run dev
```

默认访问： http://localhost:3000 。构建生产包： `npm run build`。

### MySQL 与 Neo4j

- 可使用 docker-compose 单独启动数据库服务（MySQL/Neo4j），或本地安装 MySQL/Neo4j 并按 `DATABASE_URL`/`NEO4J_*` 配置连接。

## 三、环境变量与配置说明

本节说明项目中常用的环境变量、示例及如何在本地或容器中配置。

### .env 文件位置与使用

- 项目示例：`backend/.env.example`（请以此为模板创建 `backend/.env` 或项目根目录的 `.env`）。
- 建议将实际的 `.env` 放在 `backend/` 下并加入 `.gitignore`，避免提交敏感信息到代码仓库。

在 bash 下从示例生成 `.env`：

```bash
cd backend
Copy-Item .env.example .env
# 然后用编辑器修改 .env 中的值
notepad .env
```

Docker Compose 会在启动容器时读取项目根目录或服务配置中指定的 `.env`。也可在 `docker-compose.yml` 的 environment 字段中直接写入或引用环境变量。

### 主要环境变量说明（示例来自 `backend/.env.example`）

- DATABASE_URL：数据库连接字符串，格式示例：

  - mysql://root:root@mysql:3306/aicourse
  - 说明：容器内通常使用服务名（例如 `mysql` 或 `ai_mysql`）作为主机名，若本地运行使用 `localhost`。

- NEO4J_URI / NEO4J_USER / NEO4J_PASSWORD：Neo4j 连接参数，示例：

  - NEO4J_URI=bolt://neo4j:7687
  - NEO4J_USER=neo4j
  - NEO4J_PASSWORD=aicourse

- MYSQL_ROOT_PASSWORD、MYSQL_DATABASE：MySQL 初始化密码与默认数据库名（通常在 `docker-compose.yml` 的 mysql 服务下设置）。

- CHROMA_DB_DIR / CHROMA_COLLECTION：Chroma 向量库的存储目录与集合名称（若使用 Chroma）。

- SECRET_KEY：JWT 或应用用到的对称密钥，用于签名 token 等，请使用高强度随机字符串并妥善保管。

- APP_NAME / APP_VERSION / DEBUG：应用信息与调试开关（DEBUG=True 时谨慎使用，勿在生产环境开启）。

- LOG_LEVEL / LOG_FILE：日志等级与日志文件路径（容器内路径或挂载目录）。

- OPENAI_API_KEY / OPENAI_BASE_URL / OPENAI_MODEL：外部大模型或 API 的接入配置；请妥善保管 API Key。

- XF\_\*：第三方服务（例如讯飞）相关密钥与服务地址，根据你实际使用的供应商填写。

- XDG_CACHE_HOME：可选的缓存目录，用于指定文件缓存位置。

## 四、数据备份与恢复

### MySQL 备份

```bash
# 导出数据库（宿主执行）
docker exec -i ai_mysql /usr/bin/mysqldump -u root -proot aicourse > aicourse_dump.sql
# 恢复
Get-Content aicourse_dump.sql -Raw | docker exec -i ai_mysql /usr/bin/mysql -u root -proot aicourse
```

> 说明：Windows bash 中使用 `Get-Content -Raw` 以确保二进制流正确传递。

### Neo4j 备份

- 可使用 Neo4j 提供的导出工具，或停止容器后复制 `data/neo4j` 卷目录进行文件级备份。

### 模型与向量数据

- 将 `models_/`、向量存储卷（如 data/chroma）定期拷贝到备份存储。

## 五、故障排查（部署与运维）

问题：容器未能启动或一直重启

- 查看容器日志： `docker compose logs -f <service>`。
- 常见原因：端口冲突、环境变量错误、卷权限问题。

问题：后端无法连接 MySQL

- 检查 `DATABASE_URL` 中的主机名/端口是否正确（容器内通常使用服务名，如 `mysql` 或 `ai_mysql`）。
- 检查 MySQL 容器状态： `docker compose ps`。

问题：Neo4j 无法访问或登录失败

- 检查 `NEO4J_AUTH` 是否以 `neo4j/密码` 格式配置。
- 查看 Neo4j 日志： `docker compose logs -f ai_neo4j`。

问题：性能慢（检索或问答延迟）

- 检查向量库索引是否构建完毕。
- 检查模型推理是否在 CPU 模式，若需要请使用 GPU 容器。

## 六、安全与注意事项

- 不要在公开仓库中提交密码或 `.env` 文件。
- 生产环境请使用更强的密码，并考虑使用 secret 管理服务。
